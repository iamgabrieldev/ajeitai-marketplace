name: CI/CD Pipeline - Magalu Cloud

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ------------------------------------------------------------------
  # EST√ÅGIO 1: INTEGRA√á√ÉO CONT√çNUA (TESTES)
  # ------------------------------------------------------------------
  test-backend:
    name: Backend Unit & Integration Tests
    runs-on: ubuntu-latest
    
    # Servi√ßos tempor√°rios para os testes de integra√ß√£o passarem
    # O GitHub sobe esses containers e os exp√µe via localhost
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: ajeitai_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        # Healthcheck para garantir que o banco subiu antes de rodar os testes
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run Tests with Maven
        # Define as vari√°veis de ambiente para o Spring Boot usar os servi√ßos acima
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/ajeitai_db
          SPRING_DATASOURCE_USERNAME: test_user
          SPRING_DATASOURCE_PASSWORD: test_password
          SPRING_DATA_REDIS_HOST: localhost
          SPRING_DATA_REDIS_PORT: 6379
        run: mvn clean verify -f backend/pom.xml

  # ------------------------------------------------------------------
  # EST√ÅGIO 2: BUILD E PUSH (S√≥ roda se os testes passarem)
  # ------------------------------------------------------------------
  build-and-push:
    needs: test-backend # Depend√™ncia expl√≠cita
    if: github.event_name == 'push' # S√≥ faz build no push, n√£o no PR
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Backend Build
      - name: Build and push Backend
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend:latest

      # Frontend Build (PWA)
      - name: Build and push Frontend
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:latest

  # ------------------------------------------------------------------
  # EST√ÅGIO 3: DEPLOY (MAGALU CLOUD)
  # ------------------------------------------------------------------
  deploy-magalu:
    needs: build-and-push
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.MG_HOST }}
          username: ${{ secrets.MG_USER }}
          key: ${{ secrets.MG_SSH_KEY }}
          script: |
            echo "üöÄ Iniciando Deploy na Magalu Cloud..."
            
            # Navega at√© a pasta
            cd ${{ secrets.MG_APP_DIR }}
            
            # Login no Registry para baixar imagens privadas
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # Atualiza o c√≥digo (Docker Compose file)
            git pull origin main
            
            # Baixa as novas imagens
            docker-compose -f docker-compose.prod.yml pull backend frontend
            
            # Recria os containers (Zero Downtime se usar r√©plicas, aqui haver√° breve restart)
            docker-compose -f docker-compose.prod.yml up -d --no-deps backend frontend
            
            # Limpeza
            docker image prune -f
            
            echo "‚úÖ Deploy conclu√≠do com sucesso!"